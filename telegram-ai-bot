import requests
import time
import os

TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

BASE_URL = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}"


def get_updates(offset=None):
    url = BASE_URL + "/getUpdates"
    params = {"timeout": 30}
    if offset:
        params["offset"] = offset
    r = requests.get(url, params=params, timeout=40)
    return r.json()


def send_message(chat_id, text):
    url = BASE_URL + "/sendMessage"
    requests.post(url, data={"chat_id": chat_id, "text": text})


def ask_ai(text):
    url = "https://api.openai.com/v1/chat/completions"
    headers = {
        "Authorization": f"Bearer {OPENAI_API_KEY}",
        "Content-Type": "application/json"
    }
    data = {
        "model": "gpt-4o-mini",
        "messages": [
            {"role": "system", "content": "Ты полезный ИИ-помощник."},
            {"role": "user", "content": text}
        ],
        "max_tokens": 300
    }

    r = requests.post(url, headers=headers, json=data, timeout=60)
    j = r.json()

    if "choices" not in j:
        return "⚠️ Ошибка ИИ. Попробуй позже."

    return j["choices"][0]["message"]["content"]


def main():
    print("Бот запущен ✅")
    offset = None

    while True:
        try:
            updates = get_updates(offset)

            if "result" not in updates:
                time.sleep(2)
                continue

            for update in updates["result"]:
                offset = update["update_id"] + 1

                message = update.get("message")
                if not message:
                    continue

                chat_id = message["chat"]["id"]
                text = message.get("text", "")

                if not text:
                    continue

                reply = ask_ai(text)
                send_message(chat_id, reply)

        except Exception as e:
            print("Ошибка:", e)
            time.sleep(5)


if __name__ == "__main__":
    main()
